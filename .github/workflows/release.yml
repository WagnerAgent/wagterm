name: build-and-release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: macos-latest
            arch: arm64
          - os: windows-latest
            arch: x64
    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Sync app version with tag
        if: startsWith(github.ref, 'refs/tags/')
        shell: bash
        run: npm version --no-git-tag-version "${GITHUB_REF_NAME#v}"

      - name: Build app
        run: npm run build

      - name: Rebuild native deps
        run: npm run rebuild:electron

      - name: Package (publish on tags)
        if: startsWith(github.ref, 'refs/tags/')
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: npm run package -- --publish always

      - name: Package (no publish)
        if: ${{ !startsWith(github.ref, 'refs/tags/') }}
        run: npm run package -- --publish never

      - name: Upload artifacts (manual builds)
        if: ${{ !startsWith(github.ref, 'refs/tags/') }}
        uses: actions/upload-artifact@v4
        with:
          name: wagterm-${{ matrix.os }}-${{ matrix.arch }}
          path: release/**

  update-homebrew:
    needs: build
    if: startsWith(github.ref, 'refs/tags/')
    runs-on: macos-latest

    steps:
      - name: Wait for release assets
        run: sleep 30

      - name: Get version from tag
        id: version
        run: echo "version=${GITHUB_REF_NAME#v}" >> $GITHUB_OUTPUT

      - name: Download DMG from release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release download "${{ github.ref_name }}" \
            --repo WagnerAgent/wagterm \
            --pattern "*.dmg" \
            --dir ./dmgs

      - name: Calculate SHA256
        id: sha
        run: |
          ARM64_SHA=$(shasum -a 256 ./dmgs/Wagterm-${{ steps.version.outputs.version }}-arm64.dmg | awk '{print $1}')
          echo "arm64=$ARM64_SHA" >> $GITHUB_OUTPUT

      - name: Checkout homebrew-tap
        uses: actions/checkout@v4
        with:
          repository: WagnerAgent/homebrew-tap
          token: ${{ secrets.HOMEBREW_TAP_TOKEN }}
          path: homebrew-tap

      - name: Update cask
        run: |
          cat > homebrew-tap/Casks/wagterm.rb << 'EOF'
          cask "wagterm" do
            version "${{ steps.version.outputs.version }}"
            sha256 "${{ steps.sha.outputs.arm64 }}"

            url "https://github.com/WagnerAgent/wagterm/releases/download/v#{version}/Wagterm-#{version}-arm64.dmg"
            name "Wagterm"
            desc "Open-source AI SSH desktop client"
            homepage "https://github.com/WagnerAgent/wagterm"

            livecheck do
              url :url
              strategy :github_latest
            end

            depends_on arch: :arm64

            app "Wagterm.app"

            zap trash: [
              "~/Library/Application Support/wagterm",
              "~/Library/Preferences/com.wagner.wagterm.plist",
              "~/Library/Saved Application State/com.wagner.wagterm.savedState",
            ]
          end
          EOF

      - name: Commit and push
        working-directory: homebrew-tap
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Casks/wagterm.rb
          git commit -m "Update wagterm to ${{ steps.version.outputs.version }}"
          git push
